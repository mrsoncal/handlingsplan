<!DOCTYPE html>
<html lang="no">
<link rel="stylesheet" href="styles.css">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>Forslag til Handlingsplan 2026</title>
</head>
<body>
  <header class="page-header">
    <button id="login-button" class="login-out-button">Admin</button>
    <button id="logout-button" class="login-out-button" style="display: none;">Logg ut</button>

    <div class="container">
      <h1>Forslag til Handlingsplan 2026</h1>
    </div>
  </header>
  <div class="top-buttons">
    <a class="forms-button" href="https://forms.gle/32jMP85aCXgax7Ss8" target="_blank">Åpne Forms</a>
    <a class="plan-button" href="docs/Handlingsplan%20Telemark%20Ungdomsråd%202025.pdf" target="_blank">Handlingsplan</a>
  </div>
  <div class="login-overlay" id="login-section" style="display: none;">
    <div class="login-box">
      <form id="login-form">
        <h2>Logg inn som admin</h2>
        <div class="password-toggle">
          <input type="password" id="password" name="password" required />
          <button type="button" id="togglePassword" aria-label="Toggle password visibility">
            <img id="togglePasswordIcon" src="visible.png" alt="Vis passord" />
          </button>
        </div>
        <button type="submit">Logg inn</button>
      </form>
    </div>
  </div>
</div>
  <main class="main-content container" id="main-content">
    <div class="carousel-wrapper">
      <button class="carousel-nav left" onclick="prevSlide()">❮</button>
      <button class="carousel-nav right" onclick="nextSlide()">❯</button>
      <div class="carousel">
        <div class="carousel-track" id="carousel-track"></div>
      </div>
    </div>
  </main>
  <footer class="site-footer">
    <div class="container">
      <img alt="Telemark Ungdomsråd logo" class="footer-logo" src="Bilde1.png"/>
    </div>
  </footer>

  <script src="login.js" defer></script>
  <script src="script.js" defer></script>
  <script>
    const API = '/api/suggestions';
    let store = new Map();
    let lastServerTime = null;
    let polling = null;


    function applyItem(it) {
      store.set(it.suggestion_id, it);
      const rowId = `row-${it.suggestion_id}`;
      let tr = document.getElementById(rowId);
      if (!tr) {
        tr = document.createElement('tr');
        tr.id = rowId;
        tr.innerHTML = `
        <td class="col-time"></td>
        <td class="col-name"></td>
        <td class="col-desc"></td>
        <td class="col-status"></td>
        <td class="col-actions"></td>`;
        document.querySelector('#suggestions tbody').appendChild(tr);
      }
      tr.classList.add('updating'); // turn off transitions


      // Example fields—adapt to your payload keys
      tr.querySelector('.col-time').textContent = new Date(it.payload?.time || it.created_at).toLocaleString();
      tr.querySelector('.col-name').textContent = it.payload?.name || it.payload?.title || '—';
      tr.querySelector('.col-desc').textContent = it.payload?.description || '—';


      const statusCell = tr.querySelector('.col-status');
      statusCell.textContent = it.status;
      tr.dataset.status = it.status; // for CSS coloring


      const actions = tr.querySelector('.col-actions');
      actions.innerHTML = '';
      const btn = document.createElement('button');
      btn.textContent = it.status === 'vedtatt' ? 'Opphev' : 'Vedtá';
      btn.onclick = () => toggleVedtatt(it);
      actions.appendChild(btn);


      // Allow painting after this frame
      requestAnimationFrame(() => tr.classList.remove('updating'));
    }


    async function initialLoad() {
      const res = await fetch(API);
      const data = await res.json();
      lastServerTime = data.serverTime;
      data.items.forEach(applyItem);
    }


    async function poll() {
      const url = lastServerTime ? `${API}?since=${encodeURIComponent(lastServerTime)}` : API;
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error('poll failed');
      const data = await res.json();
      if (data.items?.length) data.items.forEach(applyItem);
      lastServerTime = data.serverTime || lastServerTime;
    }


    async function toggleVedtatt(it) {
      // Optimistic lock with expectedUpdatedAt
      const body = {
        status: it.status === 'vedtatt' ? 'ny' : 'vedtatt',
        expectedUpdatedAt: it.updated_at,
        actor: window.currentUser || 'admin'
      };
      const res = await fetch(`${API}/${it.suggestion_id}`, {
        method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body)
      });
      if (res.status === 409) {
        // Conflict: refetch the latest row then re-try (optional)
        await poll();
        alert('Denne saken ble endret et annet sted. Viser siste status.');
        return;
      }
      const data = await res.json();
      applyItem(data.item);
    }


    function startPolling() {
      if (polling) clearInterval(polling);
      polling = setInterval(() => poll().catch(console.error), 10000); // 10s
    }


    window.addEventListener('load', async () => {
      await initialLoad();
      startPolling();
    });
</script>

</body>
</html>