<!DOCTYPE html>
<html lang="no">
<link rel="stylesheet" href="styles.css">
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>Forslag til Handlingsplan 2026</title>
</head>
<body>
  <header class="page-header">
    <button id="login-button" class="login-out-button">Admin</button>
    <button id="logout-button" class="login-out-button" style="display: none;">Logg ut</button>

    <div class="container">
      <h1>Forslag til Handlingsplan 2026</h1>
    </div>
  </header>
  <div class="top-buttons">
    <a class="forms-button" href="https://forms.gle/32jMP85aCXgax7Ss8" target="_blank">Åpne Forms</a>
    <a class="plan-button" href="docs/Handlingsplan%20Telemark%20Ungdomsråd%202025.pdf" target="_blank">Handlingsplan</a>
  </div>
  <div class="login-overlay" id="login-section" style="display: none;">
    <div class="login-box">
      <form id="login-form">
        <h2>Logg inn som admin</h2>
        <div class="password-toggle">
          <input type="password" id="password" name="password" required />
          <button type="button" id="togglePassword" aria-label="Toggle password visibility">
            <img id="togglePasswordIcon" src="visible.png" alt="Vis passord" />
          </button>
        </div>
        <button type="submit">Logg inn</button>
      </form>
    </div>
  </div>
</div>
  <main class="main-content container" id="main-content">
    <div class="carousel-wrapper">
      <button class="carousel-nav left" onclick="prevSlide()">❮</button>
      <button class="carousel-nav right" onclick="nextSlide()">❯</button>
      <div class="carousel">
        <div class="carousel-track" id="carousel-track"></div>
      </div>
    </div>
  </main>
  <footer class="site-footer">
    <div class="container">
      <img alt="Telemark Ungdomsråd logo" class="footer-logo" src="Bilde1.png"/>
    </div>
  </footer>

  <script src="login.js" defer></script>
  <script src="script.js" defer></script>
  <script>
    (function () {
      const API_BASE = "https://handlingsplan-backend.onrender.com";

      function withSilentUI(fn) {
        document.documentElement.classList.add("silent-update");
        try { fn(); } finally {
          requestAnimationFrame(() => {
            document.documentElement.classList.remove("silent-update");
          });
        }
      }

      async function applyChange(suggestionId) {
        // Fetch the updated vedtatt row
        const r = await fetch(`${API_BASE}/vedtatt/${encodeURIComponent(suggestionId)}`);
        if (!r.ok) return;
        const row = await r.json(); // { suggestion_id, vedtatt, updated_at }

        // Find the table row by data-suggestion-id
        const tr = document.querySelector(`tr[data-suggestion-id="${row.suggestion_id}"]`);
        if (!tr) return;

        // Toggle only the visual state; no animations
        withSilentUI(() => {
          tr.classList.toggle("vedtatt", !!row.vedtatt);

          // If there’s a button in the row, update its state/text too (optional)
          const btn = tr.querySelector(".vedta-button");
          if (btn) {
            btn.classList.toggle("vedtatt", !!row.vedtatt);
            btn.textContent = row.vedtatt ? "Vedtatt" : "Vedta";
          }
        });
      }

      // Open the SSE stream and listen for DB change events
      const es = new EventSource(`${API_BASE}/sse/events`);
      es.addEventListener("dbchange", (e) => {
        try {
          const msg = JSON.parse(e.data); // { op, suggestion_id }
          if (msg && msg.suggestion_id) applyChange(msg.suggestion_id);
        } catch { /* ignore bad payloads */ }
      });

      es.onerror = () => {
        console.warn("SSE error (will reconnect on reload).");
      };
    })();
  </script>

</body>
</html>